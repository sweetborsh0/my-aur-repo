name: AUR Build on demand

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'AUR package name (например php83)'
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    container:
      image: archlinux:base-devel
      options: --privileged

    steps:
      - name: Установка базовых пакетов + создание builder
        run: |
          pacman -Syu --noconfirm git sudo ccache gnupg curl wget base-devel

          useradd -m builder
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers.d/builder
          mkdir -p /home/builder/.ccache
          chown builder:builder /home/builder/.ccache

      - name: Настройка makepkg + ccache + много ядер
        run: |
          echo 'MAKEFLAGS="-j$(nproc)"' >> /etc/makepkg.conf
          echo 'BUILDENV=(ccache !distcc color !sign)' >> /etc/makepkg.conf
          echo 'OPTIONS=(strip docs !libtool !staticlibs emptydirs zipman purge !debug lto)' >> /etc/makepkg.conf

      - name: Кэш ccache (ускорение в 10–20× на повторных сборках)
        uses: actions/cache@v4
        with:
          path: /home/builder/.ccache
          key: ccache-${{ github.event.inputs.package }}-${{ github.run_id }}
          restore-keys: ccache-${{ github.event.inputs.package }}-

      - name: Checkout репозитория
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Сборка пакета от обычного пользователя
        run: |
          sudo -u builder bash -c "
            cd /home/builder

            # Клонируем AUR-пакет
            git clone https://aur.archlinux.org/${{ github.event.inputs.package }}.git
            cd ${{ github.event.inputs.package }}

            # Фиксим устаревшие зависимости для php83 и подобных
            sed -i 's/c-client/libc-client/' PKGBUILD 2>/dev/null || true
            sed -i 's/pcre/jansson pcre2/' PKGBUILD 2>/dev/null || true

            # Устанавливаем все зависимости автоматически
            pacman -Syu --noconfirm --needed patchelf python libedit apache argon2 libxslt postgresql-libs unixodbc firebird-libfbclient freetds gd tidy libzip oniguruma aspell enchant libvoikko hspell hunspell nuspell net-snmp libsodium libc-client

            # Игнорируем виртуальные провайдеры, которые требуют ввода
            makepkg -s --noconfirm --needed --assume-installed smtp-forwarder
            mkdir -p /tmp/repo/x86_64
            mv *.pkg.tar.* /tmp/repo/x86_64/ || true
          "

      - name: Подготовка репозитория и удаление старых версий
        run: |
          mkdir -p repo/x86_64
          cd repo/x86_64
          rm -f ${{ github.event.inputs.package }}-[0-9]*.pkg.tar.*

      - name: Копируем новые пакеты
        run: |
          cp /tmp/repo/x86_64/* repo/x86_64/ || true

      - name: Обновляем базу репозитория
        run: |
          cd repo/x86_64
          rm -f my-aur-repo.{db,files}{,.tar.gz,.old}
          repo-add my-aur-repo.db.tar.gz *.pkg.tar.*

      - name: Деплой на GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./repo/x86_64
          force_orphan: true
          commit_message: "Add/update ${{ github.event.inputs.package }}"
