name: AUR Build on demand

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'AUR package name (например php83)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write          # нужно для peaceiris/actions-gh-pages
    container:
      image: archlinux:base-devel
      options: --privileged     # нужен для makepkg и pacstrap
    steps:
      - name: Установка зависимостей и создание обычного пользователя
        run: |
          pacman -Syu --noconfirm git sudo base-devel
          useradd -m -G wheel builder
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          # разрешаем makepkg от builder'а
          sed -i 's/#MAKEFLAGS=.*/MAKEFLAGS="-j$(nproc)"/' /etc/makepkg.conf

      - name: Кэшируем ccache (ускоряет повторные сборки в 10–20 раз)
        uses: actions/cache@v4
        with:
          path: /home/builder/.ccache
          key: ccache-${{ github.event.inputs.package }}-${{ github.run_id }}
          restore-keys: |
            ccache-${{ github.event.inputs.package }}-

      - name: Сборка пакета от обычного пользователя
        run: |
          sudo -u builder bash -c "
            cd /home/builder
            git clone https://aur.archlinux.org/${{ github.event.inputs.package }}.git
            cd ${{ github.event.inputs.package }}
            makepkg -s --noconfirm --needed
            mkdir -p /tmp/repo/x86_64
            mv *.pkg.tar.zst /tmp/repo/x86_64/
          "

      - name: Копируем собранные пакеты в репозиторий
        run: |
          mkdir -p x86_64
          cp /tmp/repo/x86_64/*.pkg.tar.zst x86_64/ || true

      - name: Обновляем базу репозитория (repo-add)
        run: |
          cd x86_64
          # удаляем старые ссылки
          rm -f my-aur-repo.{db,files}.tar.gz
          repo-add my-aur-repo.db.tar.gz *.pkg.tar.zst

      - name: Деплой на GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./x86_64
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Add ${{ github.event.inputs.package }}'
